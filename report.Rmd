---
title: "Promises are made to be Broken"
output: html_document
params:
    datadir: "./data"
    graphdir: "./graphs"
    macrodir: "./macros"
---

```{r echo = FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(fst)
library(fs)
library(DT)
library(tibble)
```

```{r echo=TRUE, warning=FALSE, message=FALSE}
read_any <- function(filepath) {
    ext <- path_ext(filepath)
    if(ext == "fst") {
        read_fst(filepath)
    }
    else {
        read_lines(filepath)
    }
}

read_lazy <- function(var, filename) {
    filepath <- path_join(c(params$datadir, filename))
    eval_env <- environment()
    assign_env <- parent.frame()
    delayedAssign(as.character(substitute(var)),
                  read_any(print(filepath)),
                  eval_env,
                  assign_env)
}

compute_percentage <- function(n, precision) {
    round( (n * 100) / sum(n) , precision)
}

show_table <- function(df) {
    datatable(df)
}

read_lazy(extract_index, "extract-index.fst")
read_lazy(package_info, "package-info.fst")
read_lazy(sloc_script, "sloc-corpus.fst")
read_lazy(sloc_package, "sloc-package.fst")
read_lazy(corpus, "corpus")
read_lazy(client, "client")
read_lazy(parameters, "parameters.fst")
```

## Corpus

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE}
cat("Corpus size: ", length(corpus))
cat("Client size: ", length(client))

summarize_programs_sloc <- function(df, packages, types = c("test", "example", "testthat", "vignette")) {
    df %>%
        filter(package %in% packages) %>%
        filter(type %in% types) %>%
        filter(language %in% c("R", "C/C++ Header", "C", "C++", "Fortran 77")) %>%
        mutate(language = case_when(language == "R" ~ "R", TRUE ~ "Native")) %>%
        group_by(language, type) %>%
        summarize(count = n(), code = sum(code)) %>%
        ungroup()
}
```

### Runnable Code

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE}
runnable_code <-
   add_column(summarize_programs_sloc(sloc_script, corpus), kind = "corpus", .before = 1) %>%
   bind_rows(add_column(summarize_programs_sloc(sloc_script, client), kind = "client", .before = 1))
   
runnable_code %>% show_table()
```

### Package Code

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE}
package_code <-
   add_column(summarize_programs_sloc(sloc_package, corpus, c("R", "src")), kind = "corpus", .before = 1) %>%
   bind_rows(add_column(summarize_programs_sloc(sloc_package, client, c("R", "src")), kind = "client", .before = 1))

package_code %>% show_table()
```

### Package Functions
```{r echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE}
functions <-
    parameters %>% 
    distinct(pack_name, fun_name) %>%
    filter(pack_name %in% corpus)

cat("Total functions: ", nrow(functions))


functions %>%
    count(pack_name, name = "function_count") %>%
    arrange(desc(function_count)) %>%
    datatable()


function_distribution <-
    functions %>%
    count(pack_name, name = "count") %>%
    mutate(min_range = floor(count/25),
           max_range = ceiling(count/25)) %>%
    mutate(min_range = if_else(min_range == max_range, min_range - 1, min_range)) %>%
    mutate(functions = paste0(min_range * 25 + 1, " - ", max_range * 25)) %>% 
    count(min_range, functions, name = "packages") %>%
    arrange(min_range) %>%
    select(functions, packages)
    
    

latex <- pmap_chr(function_distribution, function(functions, packages) {
    paste0(functions, "&", packages, "\\")
})

function_distribution %>% datatable()

cat(latex)
```


### Functions

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE}
package_count <- length(unique(package_info$package))

function_count <- nrow(distinct(package_info, package, funname))

function_count_by_package <-
    package_info %>%
    mutate(exported = c("private", "public")[ as.integer(exported) + 1 ] ) %>%
    group_by(package, exported) %>%
    summarize(count = length(unique(funname))) %>%
    ungroup() %>%
    pivot_wider(names_from = exported, values_from = count, values_fill = 0) %>%
    mutate(all = public + private, perc = compute_percentage(all))
    
show_table(function_count_by_package)
```

### Function Distribution

```{r eval = TRUE}
function_count_by_package_count <-
    function_count_by_package %>%
    count(all, name = "package_count") %>%
    mutate(function_count = all) %>%
    select(package_count, function_count)
    
tail_package_count <- 
    function_count_by_package_count %>%
    dplyr::filter(function_count > 250) %>%
    pull(package_count) %>%
    sum()
    
function_count_by_package_count <-
    function_count_by_package_count %>%
    dplyr::filter(function_count <= 250) %>%
    mutate(function_count = ceiling(function_count / 5) * 5) %>%
    group_by(function_count) %>%
    summarize(package_count = sum(package_count)) %>%
    ungroup() %>%
    add_row(package_count = tail_package_count, function_count = 251)

show_table(function_count_by_package_count)

ggplot(function_count_by_package_count, aes(x = function_count, y = package_count)) +
    geom_col() +
    scale_x_binned(n.breaks = nrow(function_count_by_package_count))
```
## Corpus

### Programs

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE}
corpus_count_by_type <-
    extract_index %>%
        count(type, name = "count") %>%
        mutate(perc = compute_percentage(count))

corpus_count_by_package_type <-
    extract_index %>%
        count(package, type, name = "count") %>%
        mutate(perc = compute_percentage(count))

show_table(corpus_count_by_type)
show_table(corpus_count_by_package_type)
```

### SLOC

```{r echo=FALSE, warning=FALSE, message=FALSE, eval=TRUE}
sloc_count_by_type <-
    sloc_script %>%
        count(type, name = "count") %>%
        mutate(perc = compute_percentage(count))

sloc_count_by_package_type <-
    sloc_script %>%
        count(package, type, name = "count") %>%
        mutate(perc = compute_percentage(count))

show_table(sloc_count_by_type)
show_table(sloc_count_by_package_type)
```
