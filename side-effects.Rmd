---
title: "Side-Effecting Arguments"
output:
    html_document:
        toc: true
        toc_depth: 3
        toc_float: true
        number_sections: true
        theme: cerulean
        highlight: pygments
        code_folding: hide
        fig_width: 9
        fig_height: 3
        css: style.css
params:
    datadir: "./data"
    graphdir: "./graphs"
    macrodir: "./macros"
---

```{r echo = FALSE, warning=FALSE, message=FALSE}
## https://bookdown.org/yihui/rmarkdown-cookbook/source-script.html
source("analysis.R", local = knitr::knit_global())
```

## Functions ordered by number of effects

```{r echo = FALSE, warning=FALSE, message=FALSE}
effects_direct %>%
filter(type == "L") %>%
count(type, pack_name, fun_name, formal_pos, wt = argument_count, name = "count") %>%
arrange(desc(count)) %>%
mutate(perc = round(100 * count / sum(count), 2)) %>%
mutate(cumperc = cumsum(perc)) %>%
datatable()

effects_direct %>%
filter(type == "A") %>%
count(type, pack_name, fun_name, formal_pos, wt = argument_count, name = "count") %>%
arrange(desc(count)) %>%
mutate(perc = round(100 * count / sum(count), 2)) %>%
mutate(cumperc = cumsum(perc)) %>%
datatable()

effects_direct %>%
filter(type == "D") %>%
count(type, pack_name, fun_name, formal_pos, wt = argument_count, name = "count") %>%
arrange(desc(count)) %>%
mutate(perc = round(100 * count / sum(count), 2)) %>%
mutate(cumperc = cumsum(perc)) %>%
datatable()


effects_direct %>%
filter(type == "R") %>%
count(type, pack_name, fun_name, formal_pos, wt = argument_count, name = "count") %>%
arrange(desc(count)) %>%
mutate(perc = round(100 * count / sum(count), 2)) %>%
mutate(cumperc = cumsum(perc)) %>%
datatable()
```

```{r echo = FALSE, warning=FALSE, message=FALSE}
effects_summary <-
    effects_direct %>%
    group_by(type, pack_name, fun_name, formal_pos) %>%
    summarize(operation_count = sum(operation_count),
              argument_count = sum(argument_count)) %>%
    ungroup() %>%
    group_by(type) %>%
    summarize(operations = sum(operation_count),
              arguments = sum(argument_count),
              parameters = n(),
              functions = length(unique(paste0(pack_name, "::", fun_name))),
              packages = length(unique(pack_name))) %>%
    ungroup() %>%
    mutate(type =  factor(type, levels = c("L", "D", "A", "R", "E"))) %>%
    arrange(type)

datatable(effects_summary)


effects_summary %>%
pmap_chr(function(...) {
    paste(..., sep = "&")
}) %>%
paste(collapse = "\\\\\n") %>%
cat()
```


## Effect sequence

```{r echo = FALSE, warning=FALSE, message=FALSE}

merge_effects <- function(seq) {
    seq %>%
    str_replace_all("[L]+", "L+") %>%
    str_replace_all("[A]+", "A+") %>%
    str_replace_all("[D]+", "D+") %>%
    str_replace_all("[R]+", "R+") %>%
    str_replace_all("(L\\+D\\+)+", "(L+D+)+") %>%
    str_replace_all("(D\\+A\\+)+", "(D+A+)+") %>%
    str_replace_all("(L\\+A\\+)+", "(L+A+)+") %>%
    str_replace_all("(D\\+R\\+)+", "(D+R+)+")
}

effects_seq_summary <-
    effects_direct %>%
    mutate(self_effect_seq = if_else(self_effect_seq == "", type, self_effect_seq)) %>%
    mutate(self_effect_seq = merge_effects(self_effect_seq)) %>%
    count(self_effect_seq, wt = argument_count, name = "count") %>%
    arrange(desc(count)) %>%
    mutate(perc = round(100 * count / sum(count), 2)) %>%
    mutate(cumperc = cumsum(perc)) %>%
    slice(1:100)


datatable(effects_seq_summary)


effects_seq_summary %>%
pmap_chr(function(self_effect_seq, count, perc, cumperc) {
    paste(self_effect_seq, as_perc(perc), sep = "&")
}) %>%
paste(collapse = "\\\\\n") %>%
cat()


effects_direct %>%
filter(is.na(self_effect_seq) | self_effect_seq == "") %>%
datatable()
```


A table
- How many L, A, D, R.
- How many positions of how many functions
- correlation with promise types
- correlation with argument order
- examples of cases



argument_table
- type, arg_type, expr_type, pack_name, fun_name, position, argument_count, effect_count


argument_table
- arg_id, pack_name, fun_name, formal_pos, self_effect_seq


graph of type of things inside a promise

join with how many promises do effects
