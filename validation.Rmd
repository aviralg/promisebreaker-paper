---
title: "Validation"
output:
    html_document:
        toc: true
        toc_depth: 3
        toc_float: true
        number_sections: true
        theme: cerulean
        highlight: pygments
        code_folding: hide
        fig_width: 9
        fig_height: 3
        css: style.css
params:
    datadir: "./data"
    graphdir: "./graphs"
    macrodir: "./macros"
---

```{r echo = FALSE, warning=FALSE, message=FALSE}
## https://bookdown.org/yihui/rmarkdown-cookbook/source-script.html
source("analysis.R", local = knitr::knit_global())
```

```{r echo = FALSE, warning=FALSE, message=FALSE}
all_programs <- 
    bind_rows(distinct(exitval_raw, type, package, filename),
              distinct(stdout_raw, type, package, filename)) %>%
    distinct()

exitval_raw <-
    exitval_raw %>%
    pivot_longer(cols = c(`lazy-1`,
                          `lazy-2`,
                          `signature+force+effect+reflection`,
                          `signature+force+effect-reflection`,
                          `signature+force-effect+reflection`,
                          `signature+force-effect-reflection`,
                          `signature-force+effect+reflection`,
                          `signature-force+effect-reflection`,
                          `signature-force-effect+reflection`,
                          `signature-force-effect-reflection`),
                 names_to = "signature",
                 values_to = "exitval")

stdout_raw <-
    stdout_raw %>%
    pivot_longer(cols = c(`lazy-1`,
                          `lazy-2`,
                          `signature+force+effect+reflection`,
                          `signature+force+effect-reflection`,
                          `signature+force-effect+reflection`,
                          `signature+force-effect-reflection`,
                          `signature-force+effect+reflection`,
                          `signature-force+effect-reflection`,
                          `signature-force-effect+reflection`,
                          `signature-force-effect-reflection`),
                 names_to = "signature",
                 values_to = "stdout")
                 
                 
validation_tab <-
    exitval_raw %>%
    left_join(stdout_raw, by = c("type", "package", "filename", "signature"))
    
lazy_1_validation_tab <-
    validation_tab %>%
    filter(signature == "lazy-1") %>%
    select(-signature) %>%
    rename(lazy_1_exitval = exitval, lazy_1_stdout = stdout)
    
validation_tab <-
    validation_tab %>%
    left_join(lazy_1_validation_tab, by = c("type", "package", "filename"))
    
    
validation_summary <-
    validation_tab %>%
    mutate(exitval = exitval == 0 & exitval == lazy_1_exitval,
           stdout = stdout == lazy_1_stdout) %>%
    group_by(signature) %>%
    summarize(both = sum(exitval & stdout),
              exitval = sum(exitval),
              stdout = sum(stdout))
    
lazy_2_both <-
    validation_summary %>%
    filter(signature == "lazy-2") %>%
    pull("both")
    
lazy_2_exitval <-
    validation_summary %>%
    filter(signature == "lazy-2") %>%
    pull("exitval")

lazy_2_stdout <-
    validation_summary %>%
    filter(signature == "lazy-2") %>%
    pull("stdout")

validation_summary <-
    validation_summary %>%
    mutate(both = lazy_2_both - both,
           exitval = lazy_2_exitval - exitval,
           stdout = lazy_2_stdout - stdout) %>%
    mutate(both_perc = round(100 * both / lazy_2_both, 2),
           exitval_perc = round(100 * exitval / lazy_2_exitval, 2),
           stdout_perc = round(100 * stdout / lazy_2_stdout, 2)) %>%
    mutate(both_perc = as_perc(both_perc),
           exitval_perc = as_perc(exitval_perc),
           stdout_perc = as_perc(stdout_perc)) %>%
    mutate(signature = str_replace(signature, fixed("signature"), ""),
           signature = str_replace(signature, fixed("force"), "U"),
           signature = str_replace(signature, fixed("effect"), "E"),
           signature = str_replace(signature, fixed("reflection"), "R")) %>%
    mutate(order = 4 * str_detect(signature, fixed("-U")) +
                   2 * str_detect(signature, fixed("-E")) +
                   1 * str_detect(signature, fixed("-R"))) %>%
    arrange(order)
    #t() %>%
    #as_tibble(rownames = "row_names")

validation_summary %>% datatable()

cat(lazy_2_both)

validation_summary %>%
filter(!(signature %in% c("lazy-1", "lazy-2"))) %>%
pmap_chr(function(signature, both, exitval, stdout, both_perc, exitval_perc, stdout_perc, order) {
     res <- paste(order, signature, both, both_perc, exitval, exitval_perc, stdout, stdout_perc, sep = "&")
}) %>%
paste(collapse = "\\\\\n") %>%
cat()
```
